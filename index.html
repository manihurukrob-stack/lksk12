<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sektor 12 Finance App - Edit Supported</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .select-period {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="pb-20 text-slate-800">

    <nav class="bg-blue-900 text-white shadow-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center space-x-3 self-start md:self-center">
                <div class="bg-white/10 p-2 rounded-lg"><i class="fas fa-book-open"></i></div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Sektor 12 Finance</h1>
                    <p class="text-xs text-blue-200">Sistem Laporan Keuangan Digital</p>
                </div>
            </div>

            <div class="flex space-x-2 bg-blue-800 p-1.5 rounded-lg shadow-inner">
                <select id="sel-month" onchange="changePeriod()" class="select-period bg-blue-700 text-white text-sm font-semibold py-1.5 px-3 rounded cursor-pointer border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="0">Januari</option>
                    <option value="1">Februari</option>
                    <option value="2">Maret</option>
                    <option value="3">April</option>
                    <option value="4">Mei</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">Agustus</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Desember</option>
                </select>
                <select id="sel-year" onchange="changePeriod()" class="select-period bg-blue-700 text-white text-sm font-semibold py-1.5 px-3 rounded cursor-pointer border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>

            <button onclick="exportToPDF()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-lg transition-all flex items-center">
                <i class="fas fa-file-pdf mr-2"></i> Export PDF
            </button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 mt-6">
        
        <div id="backdate-alert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 rounded-r shadow-sm flex items-center justify-between animate-pulse">
            <div class="flex items-center">
                <i class="fas fa-history text-yellow-600 mr-3"></i>
                <p class="text-sm text-yellow-700">Anda sedang melihat/mengedit laporan masa lalu: <span id="alert-period" class="font-bold"></span></p>
            </div>
            <button onclick="resetToToday()" class="text-xs bg-yellow-200 hover:bg-yellow-300 text-yellow-800 px-2 py-1 rounded font-bold">Kembali ke Hari Ini</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-600">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Saldo Akhir</p>
                <h2 id="disp-saldo-total" class="text-2xl font-bold text-slate-800 mt-1">Rp 0</h2>
                <p class="text-[10px] text-gray-400 mt-1">Per akhir bulan terpilih</p>
            </div>
            
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-emerald-500">
                <p id="label-masuk" class="text-gray-500 text-xs font-bold uppercase tracking-wider">Pemasukan</p>
                <h2 id="disp-masuk" class="text-xl font-bold text-emerald-600 mt-1">Rp 0</h2>
            </div>
            
            <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                <p id="label-keluar" class="text-gray-500 text-xs font-bold uppercase tracking-wider">Pengeluaran</p>
                <h2 id="disp-keluar" class="text-xl font-bold text-red-600 mt-1">Rp 0</h2>
            </div>
            
            <div class="bg-blue-50 p-5 rounded-xl shadow-sm border border-blue-100">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-xs font-semibold text-blue-800">Kas Tunai</span>
                    <span id="disp-cash" class="text-sm font-bold text-blue-900">Rp 0</span>
                </div>
                <div class="w-full bg-blue-200 h-1.5 rounded-full mb-3">
                    <div class="bg-blue-600 h-1.5 rounded-full" style="width: 40%"></div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-xs font-semibold text-blue-800">Bank / Transfer</span>
                    <span id="disp-bank" class="text-sm font-bold text-blue-900">Rp 0</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                    <h3 id="form-title" class="font-bold text-lg text-slate-700 mb-4 border-b pb-2 flex items-center justify-between">
                        <span><i class="fas fa-edit text-blue-600 mr-2"></i> Input Transaksi</span>
                    </h3>
                    
                    <div id="edit-indicator" class="hidden mb-4 bg-orange-50 border-l-4 border-orange-500 p-3 rounded">
                        <p class="text-xs text-orange-700 font-bold">Mode Edit Aktif</p>
                        <p class="text-[10px] text-orange-600">Sedang mengubah data yang sudah ada.</p>
                    </div>

                    <form id="entry-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Tanggal</label>
                            <input type="date" id="tgl" required class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-colors">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jenis</label>
                                <select id="jenis" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg outline-none text-sm font-medium">
                                    <option value="pemasukan" class="text-green-600">Pemasukan (+)</option>
                                    <option value="pengeluaran" class="text-red-600">Pengeluaran (-)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Metode</label>
                                <select id="metode" class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg outline-none text-sm">
                                    <option value="Tunai">Tunai (Cash)</option>
                                    <option value="Bank">Bank (Transfer)</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Uraian / Keterangan</label>
                            <textarea id="ket" rows="3" placeholder="Contoh: Galangan Partonggoan..." required class="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg outline-none text-sm"></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">Jumlah (Rp)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-500 font-bold text-sm">Rp</span>
                                <input type="number" id="jumlah" placeholder="0" required class="w-full p-2.5 pl-10 bg-gray-50 border border-gray-300 rounded-lg outline-none text-sm font-bold text-slate-700">
                            </div>
                        </div>

                        <div class="pt-2 flex gap-2">
                            <button type="button" id="btn-cancel" onclick="cancelEdit()" class="hidden w-1/3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg shadow-sm transition-colors">
                                Batal
                            </button>
                            <button type="submit" id="btn-submit" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition-colors flex justify-center items-center">
                                <i class="fas fa-save mr-2"></i> <span>Simpan Transaksi</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md overflow-hidden min-h-[500px]">
                    <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 id="table-title" class="font-bold text-slate-700">Buku Kas Umum</h3>
                        
                        <div class="flex space-x-2">
                            <button onclick="deleteLastTransaction()" class="text-orange-500 hover:text-orange-700 text-xs font-bold bg-orange-50 px-3 py-1 rounded border border-orange-100">
                                <i class="fas fa-undo mr-1"></i> Hapus Terakhir
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-blue-900 text-white text-xs uppercase tracking-wider">
                                    <th class="p-3 border-r border-blue-800 w-24">Tanggal</th> <th class="p-3 border-r border-blue-800">Keterangan / Uraian</th>
                                    <th class="p-3 border-r border-blue-800 text-right w-28">Pemasukan</th>
                                    <th class="p-3 border-r border-blue-800 text-right w-28">Pengeluaran</th>
                                    <th class="p-3 text-right w-32">Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="table-body" class="text-sm divide-y divide-gray-100">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="empty-state" class="hidden p-10 text-center">
                        <div class="inline-block p-4 rounded-full bg-gray-100 mb-3">
                            <i class="fas fa-folder-open text-gray-400 text-2xl"></i>
                        </div>
                        <p class="text-gray-500 text-sm">Belum ada data untuk periode ini.</p>
                        <p class="text-xs text-blue-500 mt-1 cursor-pointer" onclick="document.getElementById('ket').focus()">Mulai Input Data</p>
                    </div>

                    <div id="report-footer" class="p-6 bg-slate-50 border-t mt-4 hidden">
                        <div class="flex justify-end">
                            <div class="w-full md:w-1/2 space-y-2">
                                <h4 class="font-bold text-sm text-slate-700 mb-2 border-b pb-1">Ringkasan Penutupan Kas:</h4>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Saldo Kas Tunai</span>
                                    <span id="footer-tunai" class="font-mono font-bold">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Saldo Bank</span>
                                    <span id="footer-bank" class="font-mono font-bold">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm pt-2 border-t border-gray-300">
                                    <span class="font-bold text-slate-800">Total Saldo</span>
                                    <span id="footer-total" class="font-mono font-bold text-blue-700">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. Global State Configuration ---
        const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const shortMonths = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        
        let activeMonthIndex = new Date().getMonth();
        let activeYear = new Date().getFullYear();

        // Data Storage
        let transactions = JSON.parse(localStorage.getItem('sektor12_master_data')) || [];
        
        // EDIT STATE
        let editingId = null; 

        // DOM Elements
        const selMonth = document.getElementById('sel-month');
        const selYear = document.getElementById('sel-year');
        const tableBody = document.getElementById('table-body');
        const footerDiv = document.getElementById('report-footer');
        const emptyState = document.getElementById('empty-state');
        const dateInput = document.getElementById('tgl');
        
        // Form Elements
        const form = document.getElementById('entry-form');
        const btnSubmit = document.getElementById('btn-submit');
        const btnCancel = document.getElementById('btn-cancel');
        const editIndicator = document.getElementById('edit-indicator');

        // --- 2. Initialization ---
        window.onload = function() {
            selMonth.value = activeMonthIndex;
            selYear.value = activeYear;
            updateUI();
        };

        // --- 3. Core Logic: Change Period ---
        function changePeriod() {
            activeMonthIndex = parseInt(selMonth.value);
            activeYear = parseInt(selYear.value);
            
            const realDate = new Date();
            const isBackdate = (activeYear < realDate.getFullYear()) || (activeYear === realDate.getFullYear() && activeMonthIndex < realDate.getMonth());
            
            const alertBox = document.getElementById('backdate-alert');
            const alertText = document.getElementById('alert-period');
            
            if(isBackdate) {
                alertBox.classList.remove('hidden');
                alertText.innerText = `${months[activeMonthIndex]} ${activeYear}`;
            } else {
                alertBox.classList.add('hidden');
            }

            cancelEdit(); // Always exit edit mode when changing months to prevent confusion
            updateUI();
        }

        function resetToToday() {
            const now = new Date();
            selMonth.value = now.getMonth();
            selYear.value = now.getFullYear();
            changePeriod();
        }

        function updateUI() {
            const mName = months[activeMonthIndex];
            const mShort = shortMonths[activeMonthIndex];

            document.getElementById('label-masuk').innerText = `Pemasukan (${mShort})`;
            document.getElementById('label-keluar').innerText = `Pengeluaran (${mShort})`;
            document.getElementById('table-title').innerText = `Buku Kas Umum: ${mName} ${activeYear}`;
            
            // Set Default Date only if NOT editing
            if(!editingId) {
                const paddedMonth = String(activeMonthIndex + 1).padStart(2, '0');
                dateInput.value = `${activeYear}-${paddedMonth}-01`;
            }

            renderData();
        }

        // --- 4. Form Submission (Handle Add & Edit) ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const inputDate = document.getElementById('tgl').value;
            
            // Logic Check Date Consistency
            const checkDate = new Date(inputDate);
            if(!editingId && checkDate.getMonth() !== activeMonthIndex) {
                 if(!confirm(`Tanggal (${inputDate}) tidak sesuai dengan Bulan yang dipilih. Tetap simpan?`)) return;
            }

            const payload = {
                tgl: inputDate,
                jenis: document.getElementById('jenis').value, 
                metode: document.getElementById('metode').value, 
                ket: document.getElementById('ket').value,
                jumlah: parseFloat(document.getElementById('jumlah').value)
            };

            if (editingId) {
                // UPDATE EXISTING
                const index = transactions.findIndex(t => t.id === editingId);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...payload }; // Keep ID, update data
                }
                alert("Transaksi berhasil diperbarui!");
                cancelEdit();
            } else {
                // CREATE NEW
                payload.id = Date.now();
                transactions.push(payload);
                // Clear fields
                document.getElementById('ket').value = '';
                document.getElementById('jumlah').value = '';
            }

            saveData();
            renderData();
        });

        // --- 5. Edit Functions ---
        function startEdit(id) {
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;

            // Populate Form
            document.getElementById('tgl').value = tx.tgl;
            document.getElementById('jenis').value = tx.jenis;
            document.getElementById('metode').value = tx.metode;
            document.getElementById('ket').value = tx.ket;
            document.getElementById('jumlah').value = tx.jumlah;

            // Change UI State
            editingId = id;
            
            // Update Button Styling
            btnSubmit.classList.remove('bg-blue-700', 'hover:bg-blue-800');
            btnSubmit.classList.add('bg-orange-500', 'hover:bg-orange-600');
            btnSubmit.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> <span>Update Transaksi</span>';
            
            btnCancel.classList.remove('hidden');
            document.getElementById('btn-submit').classList.remove('w-full');
            document.getElementById('btn-submit').classList.add('w-2/3');
            
            editIndicator.classList.remove('hidden');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            
            // Reset UI
            btnSubmit.classList.add('bg-blue-700', 'hover:bg-blue-800');
            btnSubmit.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            btnSubmit.innerHTML = '<i class="fas fa-save mr-2"></i> <span>Simpan Transaksi</span>';
            
            btnCancel.classList.add('hidden');
            document.getElementById('btn-submit').classList.add('w-full');
            document.getElementById('btn-submit').classList.remove('w-2/3');
            
            editIndicator.classList.add('hidden');
            
            // Reset Fields (Keep date to current period default)
            const paddedMonth = String(activeMonthIndex + 1).padStart(2, '0');
            dateInput.value = `${activeYear}-${paddedMonth}-01`;
            document.getElementById('ket').value = '';
            document.getElementById('jumlah').value = '';
        }

        // --- 6. Data Handling ---
        function saveData() {
            transactions.sort((a, b) => new Date(a.tgl) - new Date(b.tgl));
            localStorage.setItem('sektor12_master_data', JSON.stringify(transactions));
        }

        function deleteLastTransaction() {
            const currentViewData = getFilteredData();
            if(currentViewData.length > 0) {
                const lastId = currentViewData[currentViewData.length - 1].id;
                if(confirm("Hapus transaksi terakhir di tabel ini?")) {
                    transactions = transactions.filter(t => t.id !== lastId);
                    saveData();
                    renderData();
                }
            } else {
                alert("Tidak ada data di bulan ini untuk dihapus.");
            }
        }

        function getFilteredData() {
            return transactions.filter(t => {
                const d = new Date(t.tgl);
                return d.getMonth() === activeMonthIndex && d.getFullYear() === activeYear;
            });
        }

        function renderData() {
            tableBody.innerHTML = '';
            
            const filteredData = getFilteredData();
            
            let saldo = 0;
            let totalMasuk = 0;
            let totalKeluar = 0;
            let saldoTunai = 0;
            let saldoBank = 0;

            if (filteredData.length > 0) {
                footerDiv.classList.remove('hidden');
                emptyState.classList.add('hidden');
            } else {
                footerDiv.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }

            filteredData.forEach((tx, index) => {
                const masuk = tx.jenis === 'pemasukan' ? tx.jumlah : 0;
                const keluar = tx.jenis === 'pengeluaran' ? tx.jumlah : 0;
                
                saldo += (masuk - keluar);
                totalMasuk += masuk;
                totalKeluar += keluar;

                if (tx.jenis === 'pemasukan') {
                    if(tx.metode === 'Tunai') saldoTunai += tx.jumlah;
                    else saldoBank += tx.jumlah;
                } else {
                    if(tx.metode === 'Tunai') saldoTunai -= tx.jumlah;
                    else saldoBank -= tx.jumlah;
                }

                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? "bg-white hover:bg-blue-50 transition-colors group" : "bg-gray-50 hover:bg-blue-50 transition-colors group";
                
                // Added Edit Button Column
                tr.innerHTML = `
                    <td class="p-3 text-xs font-medium text-gray-600 border-r border-gray-100 whitespace-nowrap flex items-center gap-2">
                        <button onclick="startEdit(${tx.id})" class="text-blue-300 hover:text-blue-600 transition-colors p-1" title="Edit Transaksi">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        ${formatDate(tx.tgl)}
                    </td>
                    <td class="p-3 text-xs text-gray-700 border-r border-gray-100">
                        <div class="font-semibold">${tx.ket}</div>
                        <span class="text-[10px] px-1.5 py-0.5 rounded ${tx.metode === 'Bank' ? 'bg-purple-100 text-purple-700' : 'bg-gray-200 text-gray-600'}">${tx.metode}</span>
                    </td>
                    <td class="p-3 text-right text-xs font-bold text-emerald-600 border-r border-gray-100 tracking-wide">
                        ${masuk > 0 ? formatRupiah(masuk) : ''}
                    </td>
                    <td class="p-3 text-right text-xs font-bold text-red-600 border-r border-gray-100 tracking-wide">
                        ${keluar > 0 ? formatRupiah(keluar) : ''}
                    </td>
                    <td class="p-3 text-right text-xs font-bold text-blue-800 tracking-wide bg-blue-50/50">
                        ${formatRupiah(saldo)}
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            document.getElementById('disp-saldo-total').innerText = formatRupiah(saldo);
            document.getElementById('disp-masuk').innerText = formatRupiah(totalMasuk);
            document.getElementById('disp-keluar').innerText = formatRupiah(totalKeluar);
            document.getElementById('disp-cash').innerText = formatRupiah(saldoTunai);
            document.getElementById('disp-bank').innerText = formatRupiah(saldoBank);

            document.getElementById('footer-tunai').innerText = formatRupiah(saldoTunai);
            document.getElementById('footer-bank').innerText = formatRupiah(saldoBank);
            document.getElementById('footer-total').innerText = formatRupiah(saldo);

            window.finalCalculation = { saldoTunai, saldoBank, saldo };
            window.exportData = filteredData;
        }

        // --- 7. Helper Functions ---
        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        // --- 8. PDF Export (Unchanged) ---
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const currentMonthName = months[activeMonthIndex];
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("LAPORAN KEUANGAN SEKTOR 12", 105, 15, { align: "center" });
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Bulan: ${currentMonthName} ${activeYear}`, 105, 22, { align: "center" });
            
            doc.setLineWidth(0.5);
            doc.line(14, 25, 196, 25); 

            const rows = [];
            let saldoRunning = 0;
            const dataToExport = window.exportData || [];

            if(dataToExport.length === 0) {
                alert("Tidak ada data di bulan ini untuk diexport!");
                return;
            }
            
            dataToExport.forEach(t => {
                let m = t.jenis === 'pemasukan' ? t.jumlah : 0;
                let k = t.jenis === 'pengeluaran' ? t.jumlah : 0;
                saldoRunning += (m - k);

                rows.push([
                    formatDate(t.tgl),
                    t.ket,
                    m > 0 ? m.toLocaleString('id-ID') : '',
                    k > 0 ? k.toLocaleString('id-ID') : '',
                    saldoRunning.toLocaleString('id-ID')
                ]);
            });

            doc.autoTable({
                startY: 30,
                head: [['Tanggal', 'Keterangan / Uraian', 'Pemasukan', 'Pengeluaran', 'Saldo']],
                body: rows,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 2, textColor: [50, 50, 50] },
                headStyles: { fillColor: [30, 64, 175], textColor: 255, halign: 'center', fontStyle: 'bold' },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 'auto' },
                    2: { halign: 'right', cellWidth: 30 },
                    3: { halign: 'right', cellWidth: 30 },
                    4: { halign: 'right', fontStyle: 'bold', cellWidth: 30 }
                },
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            if (finalY > 230) { doc.addPage(); finalY = 20; }

            const calc = window.finalCalculation;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Pada hari ini, Buku Kas Umum ditutup dengan keadaan sebagai berikut:", 14, finalY);
            
            finalY += 8;
            doc.text("Saldo Kas Tunai", 20, finalY);
            doc.text(": Rp " + calc.saldoTunai.toLocaleString('id-ID'), 70, finalY, { align: "right" });
            
            finalY += 6;
            doc.text("Saldo Bank", 20, finalY);
            doc.text(": Rp " + calc.saldoBank.toLocaleString('id-ID'), 70, finalY, { align: "right" });
            
            finalY += 2;
            doc.line(20, finalY, 70, finalY);
            
            finalY += 5;
            doc.setFont("helvetica", "bold");
            doc.text("Jumlah Saldo", 20, finalY);
            doc.text(": Rp " + calc.saldo.toLocaleString('id-ID'), 70, finalY, { align: "right" });

            finalY += 15;
            const signatureY = finalY;
            
            const lastDay = new Date(activeYear, activeMonthIndex + 1, 0).getDate();
            const signDate = `Tangerang, ${lastDay}-${activeMonthIndex + 1}-${activeYear}`;

            doc.setFont("helvetica", "normal");
            doc.text(signDate, 160, signatureY - 5, { align: "center" });

            doc.text("Mengetahui,", 50, signatureY, { align: "center" });
            doc.text("Ketua Sektor 12", 50, signatureY + 5, { align: "center" });
            doc.text("Bendahara Sektor 12", 160, signatureY + 5, { align: "center" });

            doc.setFont("helvetica", "bold");
            doc.text("( St. Robert Manihuruk )", 50, signatureY + 30, { align: "center" });
            doc.text("( St. Robin Damanik )", 160, signatureY + 30, { align: "center" });

            doc.save(`Laporan_Keuangan_Sektor12_${currentMonthName}_${activeYear}.pdf`);
        }
    </script>
</body>
</html>